<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Healthcare Claims Collusion Detection</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr 1fr;
            gap: 20px;
            padding: 20px;
            height: 100vh;
        }
        .header {
            grid-column: 1 / -1;
            background-color: #2c3e50;
            color: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .panel {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
            display: flex;
            flex-direction: column;
        }
        .panel-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .chart-container {
            flex: 1;
            min-height: 300px;
        }
        .network-container {
            width: 100%;
            height: 100%;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        select, button {
            padding: 8px 12px;
            border-radius: 4px;
            border: 1px solid #ddd;
            background-color: white;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
        }
        button:hover {
            background-color: #2980b9;
        }
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            border-radius: 5px;
            pointer-events: none;
            font-size: 12px;
        }
        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 12px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            margin-right: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <div class="header">
            <h1>Healthcare Claims Collusion Detection</h1>
            <p>Identifying suspicious provider networks using Louvain community detection</p>
        </div>
        
        <div class="panel">
            <div class="panel-title">Provider Network Graph</div>
            <div class="controls">
                <select id="network-type">
                    <option value="hospital-doctor">Hospital-Doctor Associations</option>
                    <option value="doctor-doctor">Referring-Servicing Doctor Associations</option>
                </select>
                <button id="run-analysis">Run Analysis</button>
            </div>
            <div class="chart-container network-container" id="network-chart"></div>
            <div class="legend" id="network-legend"></div>
        </div>
        
        <div class="panel">
            <div class="panel-title">Community Statistics</div>
            <div class="chart-container" id="community-stats-chart"></div>
        </div>
        
        <div class="panel">
            <div class="panel-title">Claim Value Distribution by Community</div>
            <div class="chart-container" id="claim-distribution-chart"></div>
        </div>
        
        <div class="panel">
            <div class="panel-title">Temporal Analysis of Suspicious Claims</div>
            <div class="controls">
                <select id="time-metric">
                    <option value="count">Claim Count</option>
                    <option value="value">Claim Value</option>
                </select>
            </div>
            <div class="chart-container" id="temporal-chart"></div>
        </div>
    </div>

    <div class="tooltip" id="tooltip" style="opacity: 0;"></div>

    <script>
        // Sample data - in a real application, this would come from an API
        const sampleData = {
            'hospital-doctor': {
                nodes: [
                    { id: 'H1', name: 'City General Hospital', type: 'hospital', size: 40 },
                    { id: 'D1', name: 'Dr. Smith', type: 'doctor', community: 1, size: 15 },
                    { id: 'D2', name: 'Dr. Johnson', type: 'doctor', community: 1, size: 12 },
                    { id: 'D3', name: 'Dr. Williams', type: 'doctor', community: 1, size: 18 },
                    { id: 'D4', name: 'Dr. Brown', type: 'doctor', community: 1, size: 10 },
                    { id: 'D5', name: 'Dr. Davis', type: 'doctor', community: 2, size: 8 },
                    { id: 'D6', name: 'Dr. Miller', type: 'doctor', community: 2, size: 10 },
                    { id: 'H2', name: 'Community Hospital', type: 'hospital', size: 30 },
                    { id: 'D7', name: 'Dr. Wilson', type: 'doctor', community: 3, size: 12 },
                    { id: 'D8', name: 'Dr. Moore', type: 'doctor', community: 3, size: 14 },
                    { id: 'D9', name: 'Dr. Taylor', type: 'doctor', community: 4, size: 9 },
                    { id: 'D10', name: 'Dr. Anderson', type: 'doctor', community: 4, size: 11 }
                ],
                links: [
                    { source: 'H1', target: 'D1', value: 120 },
                    { source: 'H1', target: 'D2', value: 95 },
                    { source: 'H1', target: 'D3', value: 150 },
                    { source: 'H1', target: 'D4', value: 80 },
                    { source: 'H1', target: 'D5', value: 40 },
                    { source: 'H1', target: 'D6', value: 50 },
                    { source: 'H2', target: 'D7', value: 70 },
                    { source: 'H2', target: 'D8', value: 85 },
                    { source: 'H2', target: 'D9', value: 30 },
                    { source: 'H2', target: 'D10', value: 35 },
                    { source: 'D1', target: 'D2', value: 60 },
                    { source: 'D1', target: 'D3', value: 75 },
                    { source: 'D2', target: 'D3', value: 55 },
                    { source: 'D3', target: 'D4', value: 45 },
                    { source: 'D5', target: 'D6', value: 25 },
                    { source: 'D7', target: 'D8', value: 40 },
                    { source: 'D9', target: 'D10', value: 20 }
                ],
                communities: [
                    { id: 1, name: 'City General Cluster', suspicious: true, 
                      avgClaimValue: 1250, externalConnections: 2, internalConnections: 6 },
                    { id: 2, name: 'Community Hospital Group', suspicious: false,
                      avgClaimValue: 850, externalConnections: 5, internalConnections: 1 },
                    { id: 3, name: 'Specialty Network', suspicious: false,
                      avgClaimValue: 920, externalConnections: 4, internalConnections: 1 },
                    { id: 4, name: 'Independent Practitioners', suspicious: false,
                      avgClaimValue: 780, externalConnections: 3, internalConnections: 1 }
                ]
            },
            'doctor-doctor': {
                nodes: [
                    { id: 'RD1', name: 'Dr. Referral A', type: 'referring', community: 1, size: 15 },
                    { id: 'RD2', name: 'Dr. Referral B', type: 'referring', community: 2, size: 12 },
                    { id: 'RD3', name: 'Dr. Referral C', type: 'referring', community: 3, size: 10 },
                    { id: 'SD1', name: 'Dr. Service X', type: 'servicing', community: 1, size: 18 },
                    { id: 'SD2', name: 'Dr. Service Y', type: 'servicing', community: 1, size: 16 },
                    { id: 'SD3', name: 'Dr. Service Z', type: 'servicing', community: 2, size: 14 },
                    { id: 'SD4', name: 'Dr. Service W', type: 'servicing', community: 3, size: 12 },
                    { id: 'SD5', name: 'Dr. Service V', type: 'servicing', community: 4, size: 10 }
                ],
                links: [
                    { source: 'RD1', target: 'SD1', value: 200 },
                    { source: 'RD1', target: 'SD2', value: 180 },
                    { source: 'SD1', target: 'SD2', value: 150 },
                    { source: 'RD2', target: 'SD3', value: 90 },
                    { source: 'RD3', target: 'SD4', value: 80 },
                    { source: 'RD1', target: 'RD2', value: 30 },
                    { source: 'SD1', target: 'RD1', value: 50 },
                    { source: 'SD2', target: 'RD1', value: 60 }
                ],
                communities: [
                    { id: 1, name: 'Potential Collusion Group', suspicious: true, 
                      avgClaimValue: 1850, reciprocity: 0.8, density: 0.9 },
                    { id: 2, name: 'Standard Referral Network', suspicious: false,
                      avgClaimValue: 950, reciprocity: 0.2, density: 0.3 },
                    { id: 3, name: 'Low Activity Group', suspicious: false,
                      avgClaimValue: 820, reciprocity: 0.1, density: 0.2 },
                    { id: 4, name: 'Independent Provider', suspicious: false,
                      avgClaimValue: 750, reciprocity: 0, density: 0 }
                ]
            }
        };

        // Color scheme
        const colorScheme = {
            hospital: '#3498db',
            doctor: '#2ecc71',
            referring: '#e74c3c',
            servicing: '#f39c12',
            communities: ['#9b59b6', '#1abc9c', '#34495e', '#e67e22'],
            suspicious: '#e74c3c',
            normal: '#2ecc71'
        };

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            // Set up event listeners
            document.getElementById('run-analysis').addEventListener('click', updateDashboard);
            document.getElementById('network-type').addEventListener('change', updateDashboard);
            document.getElementById('time-metric').addEventListener('change', updateTemporalChart);
            
            // Initial render
            updateDashboard();
        });

        function updateDashboard() {
            const networkType = document.getElementById('network-type').value;
            const data = sampleData[networkType];
            
            renderNetworkChart(data);
            renderCommunityStats(data);
            renderClaimDistribution(data);
            renderTemporalChart(data);
        }

        function renderNetworkChart(data) {
            const container = document.getElementById('network-chart');
            container.innerHTML = '';
            
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            const svg = d3.select(container)
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            
            // Create a group for the zoomable area
            const g = svg.append('g');
            
            // Create a tooltip
            const tooltip = d3.select('#tooltip');
            
            // Create the simulation
            const simulation = d3.forceSimulation(data.nodes)
                .force('link', d3.forceLink(data.links).id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.size));
            
            // Draw links
            const link = g.append('g')
                .selectAll('line')
                .data(data.links)
                .enter().append('line')
                .attr('stroke-width', d => Math.sqrt(d.value) / 5)
                .attr('stroke', '#999')
                .attr('stroke-opacity', 0.6);
            
            // Draw nodes
            const node = g.append('g')
                .selectAll('circle')
                .data(data.nodes)
                .enter().append('circle')
                .attr('r', d => d.size)
                .attr('fill', d => {
                    if (d.type === 'hospital') return colorScheme.hospital;
                    if (d.type === 'doctor') return colorScheme.doctor;
                    if (d.type === 'referring') return colorScheme.referring;
                    if (d.type === 'servicing') return colorScheme.servicing;
                    return '#ccc';
                })
                .attr('stroke', d => d.community && data.communities.find(c => c.id === d.community).suspicious ? colorScheme.suspicious : '#fff')
                .attr('stroke-width', 2)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', function(event, d) {
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    
                    const community = data.communities.find(c => c.id === d.community);
                    const communityInfo = community ? 
                        `<strong>Community:</strong> ${community.name}<br>
                         <strong>Status:</strong> ${community.suspicious ? 'Suspicious' : 'Normal'}` : '';
                    
                    tooltip.html(`
                        <strong>${d.name}</strong><br>
                        <strong>Type:</strong> ${d.type}<br>
                        ${communityInfo}
                    `)
                        .style('left', (event.pageX + 10) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                    
                    d3.select(this).attr('stroke', '#000').attr('stroke-width', 3);
                })
                .on('mouseout', function() {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                    
                    d3.select(this).attr('stroke', d => {
                        const community = data.communities.find(c => c.id === d.community);
                        return community && community.suspicious ? colorScheme.suspicious : '#fff';
                    }).attr('stroke-width', 2);
                });
            
            // Add labels
            const labels = g.append('g')
                .selectAll('text')
                .data(data.nodes)
                .enter().append('text')
                .attr('dy', -15)
                .attr('text-anchor', 'middle')
                .text(d => d.name)
                .style('font-size', '10px')
                .style('fill', '#333')
                .style('pointer-events', 'none')
                .style('display', d => d.size > 12 ? 'block' : 'none');
            
            // Update positions on each tick
            simulation.on('tick', () => {
                link
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                
                node
                    .attr('cx', d => d.x)
                    .attr('cy', d => d.y);
                
                labels
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            
            // Add zoom functionality
            svg.call(d3.zoom()
                .extent([[0, 0], [width, height]])
                .scaleExtent([0.5, 8])
                .on('zoom', zoomed));
            
            function zoomed(event) {
                g.attr('transform', event.transform);
            }
            
            function dragstarted(event, d) {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x;
                d.fy = d.y;
            }
            
            function dragged(event, d) {
                d.fx = event.x;
                d.fy = event.y;
            }
            
            function dragended(event, d) {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null;
                d.fy = null;
            }
            
            // Update legend
            const legendContainer = document.getElementById('network-legend');
            legendContainer.innerHTML = '';
            
            const types = [...new Set(data.nodes.map(n => n.type))];
            types.forEach(type => {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = colorScheme[type];
                
                const label = document.createElement('span');
                label.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                
                item.appendChild(colorBox);
                item.appendChild(label);
                legendContainer.appendChild(item);
            });
            
            // Add suspicious community indicator if any
            if (data.communities.some(c => c.suspicious)) {
                const item = document.createElement('div');
                item.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = colorScheme.suspicious;
                colorBox.style.border = '2px solid ' + colorScheme.suspicious;
                
                const label = document.createElement('span');
                label.textContent = 'Suspicious Community';
                
                item.appendChild(colorBox);
                item.appendChild(label);
                legendContainer.appendChild(item);
            }
        }

        function renderCommunityStats(data) {
            const container = document.getElementById('community-stats-chart');
            container.innerHTML = '';
            
            const chart = echarts.init(container);
            
            const option = {
                tooltip: {
                    trigger: 'axis',
                    axisPointer: {
                        type: 'shadow'
                    }
                },
                legend: {
                    data: ['Average Claim Value', 'Internal Connections', 'External Connections']
                },
                grid: {
                    left: '3%',
                    right: '4%',
                    bottom: '3%',
                    containLabel: true
                },
                xAxis: {
                    type: 'category',
                    data: data.communities.map(c => c.name)
                },
                yAxis: [
                    {
                        type: 'value',
                        name: 'Claim Value',
                        axisLabel: {
                            formatter: '${value}'
                        }
                    },
                    {
                        type: 'value',
                        name: 'Connections',
                        position: 'right'
                    }
                ],
                series: [
                    {
                        name: 'Average Claim Value',
                        type: 'bar',
                        data: data.communities.map(c => ({
                            value: c.avgClaimValue,
                            itemStyle: {
                                color: c.suspicious ? colorScheme.suspicious : colorScheme.normal
                            }
                        })),
                        yAxisIndex: 0
                    },
                    {
                        name: 'Internal Connections',
                        type: 'line',
                        data: data.communities.map(c => c.internalConnections || c.density * 10),
                        yAxisIndex: 1,
                        symbol: 'circle',
                        symbolSize: 8,
                        lineStyle: {
                            width: 3
                        }
                    },
                    {
                        name: 'External Connections',
                        type: 'line',
                        data: data.communities.map(c => c.externalConnections || (1 - c.density) * 10),
                        yAxisIndex: 1,
                        symbol: 'diamond',
                        symbolSize: 8,
                        lineStyle: {
                            width: 3,
                            type: 'dashed'
                        }
                    }
                ]
            };
            
            chart.setOption(option);
            
            window.addEventListener('resize', function() {
                chart.resize();
            });
        }

        function renderClaimDistribution(data) {
            const container = document.getElementById('claim-distribution-chart');
            container.innerHTML = '';
            
            const ctx = document.createElement('canvas');
            container.appendChild(ctx);
            
            // Prepare data
            const communityData = {};
            data.communities.forEach(community => {
                communityData[community.id] = {
                    label: community.name,
                    data: generateRandomClaimValues(community.avgClaimValue, 20),
                    backgroundColor: community.suspicious ? 
                        'rgba(231, 76, 60, 0.5)' : 'rgba(46, 204, 113, 0.5)',
                    borderColor: community.suspicious ? 
                        'rgba(231, 76, 60, 1)' : 'rgba(46, 204, 113, 1)',
                    borderWidth: 1
                };
            });
            
            new Chart(ctx, {
                type: 'boxplot',
                data: {
                    labels: data.communities.map(c => c.name),
                    datasets: Object.keys(communityData).map(key => communityData[key])
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Claim Value Distribution by Community'
                        },
                        tooltip: {
                            callbacks: {
                                beforeTitle: function(context) {
                                    const communityId = context[0].datasetIndex + 1;
                                    const community = data.communities.find(c => c.id === communityId);
                                    return community.suspicious ? '⚠️ ' + community.name : community.name;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Claim Value ($)'
                            }
                        }
                    }
                }
            });
            
            function generateRandomClaimValues(mean, count) {
                const result = [];
                for (let i = 0; i < count; i++) {
                    // Generate values with some variance around the mean
                    const value = mean * (0.8 + Math.random() * 0.4);
                    result.push(Math.round(value));
                }
                return result;
            }
        }

        function renderTemporalChart(data) {
            const metric = document.getElementById('time-metric').value;
            updateTemporalChart();
            
            function updateTemporalChart() {
                const container = document.getElementById('temporal-chart');
                container.innerHTML = '';
                
                const ctx = document.createElement('canvas');
                container.appendChild(ctx);
                
                // Generate time series data
                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                const datasets = [];
                
                data.communities.forEach(community => {
                    const baseValue = metric === 'value' ? 
                        community.avgClaimValue / 10 : 
                        (community.internalConnections || community.density * 20);
                    
                    const dataPoints = months.map((month, i) => {
                        // Add some seasonality and random variation
                        const seasonality = 1 + 0.2 * Math.sin(i / 2);
                        const variation = 0.8 + Math.random() * 0.4;
                        return Math.round(baseValue * seasonality * variation);
                    });
                    
                    datasets.push({
                        label: community.name + (community.suspicious ? ' (Suspicious)' : ''),
                        data: dataPoints,
                        borderColor: community.suspicious ? colorScheme.suspicious : colorScheme.normal,
                        backgroundColor: 'rgba(255, 255, 255, 0)',
                        borderWidth: 2,
                        pointRadius: community.suspicious ? 4 : 3,
                        pointHoverRadius: 6,
                        tension: 0.3
                    });
                });
                
                new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: months,
                        datasets: datasets
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Monthly ${metric === 'value' ? 'Claim Values' : 'Claim Counts'} by Community`
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: metric === 'value' ? 'Total Claim Value ($)' : 'Number of Claims'
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
            }
        }
    </script>
</body>
</html>